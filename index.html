<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandVolt Snapshot â€” Energy Grid Viewer and Exporter</title>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- Simpler, non-futuristic font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0b1120;
            overflow: hidden;
            color: #0f172a;
        }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        .panel {
            background: rgba(15, 23, 42, 0.92);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .title-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 18px 20px;
            max-width: 360px;
        }
        .title-panel h1 {
            font-size: 20px;
            font-weight: 700;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        .title-panel h1 span {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #9ca3af;
        }
        .title-panel .subtitle {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.5;
            margin-top: 6px;
        }
        .title-panel .subtitle strong {
            color: #e5e7eb;
            font-weight: 600;
        }

        /* Search */
        .search-section { margin-top: 14px; }
        .search-section label {
            display: block;
            font-size: 11px;
            color: #cbd5f5;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 6px;
        }
        .search-container { display: flex; gap: 8px; }
        .search-input {
            flex: 1;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.8);
            border-radius: 6px;
            padding: 8px 10px;
            color: #e5e7eb;
            font-size: 13px;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .search-input:focus {
            border-color: #38bdf8;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
        }
        .search-input::placeholder { color: #6b7280; }
        .search-btn {
            background: #38bdf8;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            color: #0f172a;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            white-space: nowrap;
        }
        .search-btn:hover { background: #0ea5e9; }
        .search-hint { font-size: 11px; color: #6b7280; margin-top: 4px; }

        /* Buffer control */
        .buffer-control {
            margin-top: 12px;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.6);
        }
        .buffer-control label {
            display: block;
            font-size: 11px;
            color: #cbd5f5;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 6px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .buffer-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: rgba(148, 163, 184, 0.5);
            border-radius: 999px;
            outline: none;
        }
        .buffer-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #38bdf8;
            border-radius: 999px;
            cursor: pointer;
            border: 2px solid #0f172a;
        }
        .buffer-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #38bdf8;
            border-radius: 999px;
            cursor: pointer;
            border: 2px solid #0f172a;
        }
        .buffer-value {
            font-size: 13px;
            font-weight: 600;
            color: #e5e7eb;
            min-width: 52px;
            text-align: right;
        }

        /* Layer panel */
        .layer-panel {
            position: absolute;
            top: 20px;
            left: 400px;
            padding: 14px 18px;
            min-width: 230px;
        }
        .layer-panel h3 {
            font-size: 12px;
            font-weight: 600;
            color: #e5e7eb;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 10px;
        }
        .layer-group-title {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 6px;
        }

        .basemap-group { margin-bottom: 10px; }
        .basemap-toggle {
            display: flex;
            gap: 10px;
            font-size: 12px;
            color: #e5e7eb;
        }
        .basemap-toggle label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .basemap-toggle input {
            accent-color: #38bdf8;
            cursor: pointer;
        }

        .layer-group { margin-top: 8px; }
        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer;
        }
        .layer-toggle:last-child { margin-bottom: 0; }

        .layer-checkbox {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid;
            font-size: 11px;
            color: #0f172a;
        }
        .layer-checkbox.checked {
            background: currentColor;
        }
        .layer-checkbox.checked::after {
            content: 'âœ“';
            color: #0f172a;
            font-size: 10px;
            font-weight: 700;
        }
        .layer-checkbox.transmission {
            border-color: #38bdf8;
            color: #38bdf8;
        }
        .layer-checkbox.substations {
            border-color: #f97373;
            color: #f97373;
        }
        .layer-checkbox.pipelines {
            border-color: #f97316;
            color: #f97316;
        }
        .layer-label {
            font-size: 13px;
            color: #e5e7eb;
            font-weight: 500;
        }
        .layer-count {
            font-size: 11px;
            color: #9ca3af;
            margin-left: auto;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 40px;
            left: 20px;
            padding: 14px 18px;
        }
        .legend h3 {
            font-size: 11px;
            font-weight: 600;
            color: #e5e7eb;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }
        .legend-section { margin-bottom: 10px; }
        .legend-section:last-child { margin-bottom: 0; }
        .legend-section-title {
            font-size: 10px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
            color: #e5e7eb;
        }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-color {
            width: 22px;
            height: 3px;
            border-radius: 999px;
            margin-right: 8px;
        }
        .legend-dot {
            width: 9px;
            height: 9px;
            border-radius: 999px;
            margin-right: 8px;
        }
        .legend-color.v1 { background: #6366f1; }
        .legend-color.v2 { background: #a855f7; }
        .legend-color.v3 { background: #22d3ee; }
        .legend-color.v4 { background: #4ade80; }
        .legend-color.v5 { background: #facc15; }
        .legend-color.v6 { background: #fb923c; }
        .legend-color.dc { background: #f472b6; }
        .legend-dot.substation { background: #f97373; }
        .legend-color.pipeline { background: #f97316; }

        /* Buffer panel */
        .buffer-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 380px;
            max-height: calc(100vh - 40px);
            background: rgba(15, 23, 42, 0.96);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .buffer-panel.visible { display: flex; }

        .buffer-header {
            padding: 14px 18px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.5);
            flex-shrink: 0;
        }
        .buffer-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .close-btn {
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.9);
            color: #e5e7eb;
            width: 24px;
            height: 24px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover {
            background: rgba(31, 41, 55, 0.9);
        }
        .buffer-info {
            font-size: 12px;
            color: #9ca3af;
        }
        .buffer-info strong {
            color: #e5e7eb;
            font-weight: 600;
        }
        .buffer-stats {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .buffer-stat {
            flex: 1;
            min-width: 100px;
            padding: 8px 8px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            text-align: center;
        }
        .buffer-stat.substations {
            border-color: rgba(248, 113, 113, 0.9);
        }
        .buffer-stat.pipelines {
            border-color: rgba(249, 115, 22, 0.9);
        }
        .buffer-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
        }
        .buffer-stat.substations .buffer-stat-value {
            color: #fecaca;
        }
        .buffer-stat.pipelines .buffer-stat-value {
            color: #fed7aa;
        }
        .buffer-stat-label {
            font-size: 10px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-top: 2px;
        }

        .buffer-tabs {
            display: flex;
            border-bottom: 1px solid rgba(148, 163, 184, 0.5);
        }
        .buffer-tab {
            flex: 1;
            padding: 9px 6px;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .buffer-tab.active {
            color: #e5e7eb;
            border-bottom-color: #38bdf8;
        }
        .buffer-tab.substations.active {
            border-bottom-color: #f97373;
        }
        .buffer-tab.pipelines.active {
            border-bottom-color: #f97316;
        }

        .buffer-results {
            flex: 1;
            overflow-y: auto;
            padding: 10px 12px;
        }
        .buffer-results::-webkit-scrollbar { width: 5px; }
        .buffer-results::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.9);
        }
        .buffer-results::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.8);
            border-radius: 999px;
        }
        .results-section { display: none; }
        .results-section.active { display: block; }

        .item-card {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.8);
            border-radius: 8px;
            padding: 10px 11px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .item-card.substation {
            border-color: rgba(248, 113, 113, 0.9);
        }
        .item-card.pipeline {
            border-color: rgba(249, 115, 22, 0.9);
        }
        .item-title {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 7px;
            border-radius: 999px;
            display: inline-block;
            margin-bottom: 6px;
        }
        .item-title.v1 { background: rgba(99, 102, 241, 0.15); color: #c7d2fe; }
        .item-title.v2 { background: rgba(168, 85, 247, 0.15); color: #e9d5ff; }
        .item-title.v3 { background: rgba(34, 211, 238, 0.15); color: #a5f3fc; }
        .item-title.v4 { background: rgba(74, 222, 128, 0.15); color: #bbf7d0; }
        .item-title.v5 { background: rgba(250, 204, 21, 0.15); color: #fef3c7; }
        .item-title.v6 { background: rgba(251, 146, 60, 0.15); color: #fed7aa; }
        .item-title.v7 { background: rgba(244, 114, 182, 0.15); color: #f9a8d4; }
        .item-title.substation {
            background: rgba(248, 113, 113, 0.15);
            color: #fecaca;
        }
        .item-title.pipeline {
            background: rgba(249, 115, 22, 0.15);
            color: #fed7aa;
        }

        .item-detail {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(30, 41, 59, 0.9);
        }
        .item-detail:last-child { border-bottom: none; }
        .item-label {
            color: #9ca3af;
            font-size: 11px;
        }
        .item-value {
            color: #e5e7eb;
            font-weight: 500;
            text-align: right;
            max-width: 180px;
            word-wrap: break-word;
            font-size: 11px;
        }

        .no-results {
            text-align: center;
            padding: 24px 12px;
            color: #9ca3af;
            font-size: 13px;
        }
        .no-results .icon {
            font-size: 30px;
            margin-bottom: 6px;
        }

        /* Export in buffer panel */
        .buffer-export {
            padding: 10px 18px;
            border-top: 1px solid rgba(148, 163, 184, 0.5);
            flex-shrink: 0;
        }
        .buffer-export-title {
            font-size: 10px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 6px;
        }
        .buffer-export-buttons {
            display: flex;
            gap: 8px;
        }
        .buffer-export-btn {
            flex: 1;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(148, 163, 184, 0.8);
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            cursor: pointer;
        }
        .buffer-export-btn.csv {
            border-color: #38bdf8;
            color: #e0f2fe;
        }
        .buffer-export-btn.geojson {
            border-color: #4ade80;
            color: #bbf7d0;
        }
        .buffer-export-btn:hover {
            background: rgba(30, 64, 175, 0.6);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #22c55e;
            color: #022c22;
            padding: 10px 18px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 13px;
            z-index: 3000;
            opacity: 0;
            transition: all 0.25s ease;
            box-shadow: 0 12px 30px rgba(22, 163, 74, 0.4);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.4s, visibility 0.4s;
        }
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(148, 163, 184, 0.5);
            border-top-color: #38bdf8;
            border-radius: 999px;
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            margin-top: 18px;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #e5e7eb;
        }
        .loading-subtext {
            margin-top: 6px;
            font-size: 13px;
            color: #9ca3af;
        }
        .loading-progress {
            width: 180px;
            height: 4px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 999px;
            margin-top: 12px;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #38bdf8, #4ade80);
            border-radius: 999px;
            transition: width 0.3s;
        }

        /* Stats bar (bottom center) */
        .stats-bar {
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 18px;
            opacity: 0;
            transition: all 0.3s;
        }
        .stats-bar.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .stat-item { text-align: center; }
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
        }
        .stat-value.substations {
            color: #fecaca;
        }
        .stat-value.pipelines {
            color: #fed7aa;
        }
        .stat-label {
            font-size: 10px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-top: 2px;
        }

        /* Popups */
        .maplibregl-popup-content {
            background: rgba(15, 23, 42, 0.97);
            border: 1px solid rgba(148, 163, 184, 0.8);
            border-radius: 10px;
            padding: 0;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .maplibregl-popup-tip {
            border-top-color: rgba(15, 23, 42, 0.97);
        }
        .popup-content {
            padding: 10px 12px;
        }
        .popup-title {
            font-size: 13px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        }
        .popup-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
        }
        .popup-row:last-child { margin-bottom: 0; }
        .popup-label { color: #9ca3af; }
        .popup-value { color: #e5e7eb; font-weight: 500; }

        .buffer-marker {
            width: 16px;
            height: 16px;
            background: #38bdf8;
            border-radius: 999px;
            border: 2px solid #0f172a;
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.35);
        }

        .geocode-marker {
            width: 20px;
            height: 20px;
            background: #22c55e;
            border-radius: 999px;
            border: 3px solid #e5e7eb;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Loading -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">LandVolt Snapshot</div>
        <div class="loading-subtext" id="loading-status">Initializing Grid</div>
        <div class="loading-progress"><div class="loading-progress-bar" id="progress-bar"></div></div>
    </div>

    <!-- Title / search / buffer -->
    <div class="title-panel panel">
        <h1>
            LandVolt Snapshot
            <span>Energy Grid Viewer</span>
        </h1>
        <p class="subtitle">
            Visualization of <strong>transmission lines</strong>, <strong>substations</strong>, and <strong>gas pipelines</strong> across the U.S.
        </p>

        <div class="search-section">
            <label>Search Location</label>
            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Address or coordinates (lat, lng)">
                <button class="search-btn" id="search-btn">Go</button>
            </div>
            <div class="search-hint">
                Enter address, city, or coordinates like <code>40.7128, -74.0060</code>
            </div>
        </div>

        <div class="buffer-control">
            <label>Buffer Radius</label>
            <div class="slider-container">
                <input type="range" class="buffer-slider" id="buffer-slider" min="0.5" max="20" step="0.5" value="2">
                <span class="buffer-value" id="buffer-value">2 mi</span>
            </div>
        </div>
    </div>

    <!-- Layer / basemap controls -->
    <div class="layer-panel panel">
        <h3>Display</h3>

        <div class="basemap-group">
            <div class="layer-group-title">Basemap</div>
            <div class="basemap-toggle">
                <label><input type="radio" name="basemap" value="dark" checked> Streets</label>
                <label><input type="radio" name="basemap" value="satellite"> Satellite</label>
            </div>
        </div>

        <div class="layer-group">
            <div class="layer-group-title">Infrastructure</div>
            <div class="layer-toggle" data-layer="transmission">
                <div class="layer-checkbox transmission checked"></div>
                <span class="layer-label">Transmission Lines</span>
                <span class="layer-count" id="transmission-count">-</span>
            </div>
            <div class="layer-toggle" data-layer="substations">
                <div class="layer-checkbox substations checked"></div>
                <span class="layer-label">Substations</span>
                <span class="layer-count" id="substations-count">-</span>
            </div>
            <div class="layer-toggle" data-layer="pipelines">
                <div class="layer-checkbox pipelines checked"></div>
                <span class="layer-label">Gas Pipelines</span>
                <span class="layer-count" id="pipelines-count">-</span>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend panel">
        <h3>Legend</h3>
        <div class="legend-section">
            <div class="legend-section-title">Transmission (Voltage)</div>
            <div class="legend-item"><div class="legend-color v1"></div><span>&lt;100 kV</span></div>
            <div class="legend-item"><div class="legend-color v2"></div><span>100â€“161 kV</span></div>
            <div class="legend-item"><div class="legend-color v3"></div><span>220â€“287 kV</span></div>
            <div class="legend-item"><div class="legend-color v4"></div><span>345 kV</span></div>
            <div class="legend-item"><div class="legend-color v5"></div><span>500 kV</span></div>
            <div class="legend-item"><div class="legend-color v6"></div><span>735+ kV</span></div>
            <div class="legend-item"><div class="legend-color dc"></div><span>DC</span></div>
        </div>
        <div class="legend-section">
            <div class="legend-section-title">Other</div>
            <div class="legend-item"><div class="legend-dot substation"></div><span>Substations</span></div>
            <div class="legend-item"><div class="legend-color pipeline"></div><span>Gas Pipelines</span></div>
        </div>
    </div>

    <!-- Buffer panel (appears when user clicks location) -->
    <div class="buffer-panel" id="buffer-panel">
        <div class="buffer-header">
            <h2>
                <span>Buffer Analysis</span>
                <button class="close-btn" id="close-buffer">Ã—</button>
            </h2>
            <div class="buffer-info">
                <strong id="buffer-radius-display">2-mile radius</strong> at
                <span id="buffer-coords">--</span>
            </div>
            <div class="buffer-stats">
                <div class="buffer-stat">
                    <div class="buffer-stat-value" id="line-count">0</div>
                    <div class="buffer-stat-label">Lines</div>
                </div>
                <div class="buffer-stat substations">
                    <div class="buffer-stat-value" id="substation-count">0</div>
                    <div class="buffer-stat-label">Substations</div>
                </div>
                <div class="buffer-stat pipelines">
                    <div class="buffer-stat-value" id="pipeline-count">0</div>
                    <div class="buffer-stat-label">Pipelines</div>
                </div>
                <div class="buffer-stat">
                    <div class="buffer-stat-value" id="highest-voltage">â€”</div>
                    <div class="buffer-stat-label">Highest Voltage</div>
                </div>
            </div>
        </div>

        <div class="buffer-tabs">
            <button class="buffer-tab active" data-tab="lines">Lines</button>
            <button class="buffer-tab substations" data-tab="substations">Substations</button>
            <button class="buffer-tab pipelines" data-tab="pipelines">Pipelines</button>
        </div>

        <div class="buffer-results" id="buffer-results">
            <div class="results-section active" id="results-lines"></div>
            <div class="results-section" id="results-substations"></div>
            <div class="results-section" id="results-pipelines"></div>
        </div>

        <!-- Export current tab + all layers for this buffer -->
        <div class="buffer-export">
            <div class="buffer-export-title">Export Current Layer (Active Tab)</div>
            <div class="buffer-export-buttons">
                <button class="buffer-export-btn csv" id="export-current-csv">CSV</button>
                <button class="buffer-export-btn geojson" id="export-current-geojson">GeoJSON</button>
            </div>
        </div>
        <div class="buffer-export">
            <div class="buffer-export-title">Export All Layers in Buffer</div>
            <div class="buffer-export-buttons">
                <button class="buffer-export-btn csv" id="export-buffer-csv">CSV</button>
                <button class="buffer-export-btn geojson" id="export-buffer-geojson">GeoJSON</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Export complete!</div>

    <!-- Stats bar (totals, bottom center) -->
    <div class="stats-bar panel" id="stats">
        <div class="stat-item">
            <div class="stat-value" id="lineCount">â€”</div>
            <div class="stat-label">Lines</div>
        </div>
        <div class="stat-item">
            <div class="stat-value substations" id="substationCount">â€”</div>
            <div class="stat-label">Substations</div>
        </div>
        <div class="stat-item">
            <div class="stat-value pipelines" id="pipelineCount">â€”</div>
            <div class="stat-label">Pipelines</div>
        </div>
    </div>

    <script>
        let partialDataLoaded = false;
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'carto-dark': {
                        type: 'raster',
                        tiles: [
                            'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'
                        ],
                        tileSize: 256
                    },
                    'esri-imagery': {
                        type: 'raster',
                        tiles: [
                            'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                        ],
                        tileSize: 256
                    }
                },
                layers: [
                    {
                        id: 'carto-dark-layer',
                        type: 'raster',
                        source: 'carto-dark',
                        minzoom: 0,
                        maxzoom: 20
                    },
                    {
                        id: 'esri-imagery-layer',
                        type: 'raster',
                        source: 'esri-imagery',
                        minzoom: 0,
                        maxzoom: 20,
                        layout: { visibility: 'none' }
                    }
                ]
            },
            center: [-98.5, 39.5],
            zoom: 4,
            minZoom: 3,
            maxZoom: 18
        });

        map.addControl(new maplibregl.NavigationControl(), 'top-right');

        let allTransmissionLines = null, allSubstations = null, allPipelines = null;
        let currentMarker = null, geocodeMarker = null;
        let currentBufferRadius = 2, lastClickedLngLat = null;
        let layerVisibility = { transmission: true, substations: true, pipelines: true };
        let currentBufferResults = null;

        const glowColors = {
            1: '#6366f1',
            2: '#a855f7',
            3: '#22d3ee',
            4: '#4ade80',
            5: '#facc15',
            6: '#fb923c',
            7: '#f472b6'
        };

        function getVoltageRank(vc) {
            if (!vc) return 1;
            const v = String(vc).toUpperCase();
            if (v.includes('DC')) return 7;
            if (v.includes('735') || v.includes('765') || v.includes('1000')) return 6;
            if (v.includes('500')) return 5;
            if (v.includes('345')) return 4;
            if (v.includes('220') || v.includes('230') || v.includes('287')) return 3;
            if (v.includes('100') || v.includes('115') || v.includes('138') || v.includes('161')) return 2;
            return 1;
        }

        function getVoltageCategory(vc) {
            if (!vc) return 'Unknown';
            const v = String(vc).toUpperCase();
            if (v.includes('DC')) return 'DC';
            if (v.includes('735') || v.includes('765') || v.includes('1000')) return '735+ kV';
            if (v.includes('500')) return '500 kV';
            if (v.includes('345')) return '345 kV';
            if (v.includes('220') || v.includes('230') || v.includes('287')) return '220-287 kV';
            if (v.includes('100') || v.includes('115') || v.includes('138') || v.includes('161')) return '100-161 kV';
            return '<100 kV';
        }

        // Buffer slider
        const slider = document.getElementById('buffer-slider');
        slider.addEventListener('input', e => {
            currentBufferRadius = parseFloat(e.target.value);
            document.getElementById('buffer-value').textContent = `${currentBufferRadius} mi`;
            if (lastClickedLngLat) updateBuffer(lastClickedLngLat);
        });

        // Buffer tabs
        document.querySelectorAll('.buffer-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.buffer-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.results-section').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`results-${tab.dataset.tab}`).classList.add('active');
            });
        });

        // Layer toggles
        document.querySelectorAll('.layer-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const layer = toggle.dataset.layer;
                const checkbox = toggle.querySelector('.layer-checkbox');
                checkbox.classList.toggle('checked');
                layerVisibility[layer] = checkbox.classList.contains('checked');
                updateLayerVisibility();
            });
        });

        function updateLayerVisibility() {
            const transLayers = ['transmission-glow', 'transmission-core'];
            const subLayers = ['substations-glow', 'substations-core'];
            const pipeLayers = ['pipelines-glow', 'pipelines-core'];

            transLayers.forEach(l => {
                if (map.getLayer(l)) {
                    map.setLayoutProperty(l, 'visibility', layerVisibility.transmission ? 'visible' : 'none');
                }
            });
            subLayers.forEach(l => {
                if (map.getLayer(l)) {
                    map.setLayoutProperty(l, 'visibility', layerVisibility.substations ? 'visible' : 'none');
                }
            });
            pipeLayers.forEach(l => {
                if (map.getLayer(l)) {
                    map.setLayoutProperty(l, 'visibility', layerVisibility.pipelines ? 'visible' : 'none');
                }
            });
        }

        // Search / geocoding
        document.getElementById('search-btn').addEventListener('click', doSearch);
        document.getElementById('search-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') doSearch();
        });

        async function doSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;

            const coordMatch = query.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
            if (coordMatch) {
                const lat = parseFloat(coordMatch[1]);
                const lng = parseFloat(coordMatch[2]);
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    goToLocation(lng, lat, query);
                    return;
                }
            }

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=us`
                );
                const data = await response.json();
                if (data.length > 0) {
                    const result = data[0];
                    goToLocation(parseFloat(result.lon), parseFloat(result.lat), result.display_name);
                } else {
                    alert('Location not found. Try a different search term.');
                }
            } catch (e) {
                alert('Error searching for location.');
            }
        }

        function goToLocation(lng, lat, name) {
            if (geocodeMarker) geocodeMarker.remove();

            const el = document.createElement('div');
            el.className = 'geocode-marker';
            geocodeMarker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);

            map.flyTo({ center: [lng, lat], zoom: 12 });

            lastClickedLngLat = { lng, lat };
            setTimeout(() => updateBuffer({ lng, lat }), 500);
        }

        // Data fetching
        async function fetchPaginated(baseUrl, statusPrefix, progressStart, progressEnd) {
            const pageSize = 2000;
            let offset = 0, features = [], hasMore = true, totalCount = 100000;

            try {
                const countResp = await fetch(`${baseUrl}?where=1%3D1&returnCountOnly=true&f=json`);
                const countData = await countResp.json();
                if (countData.count) totalCount = countData.count;
            } catch (e) {
                console.warn(`Could not get totalCount for ${statusPrefix}`, e);
            }

            while (hasMore && offset < totalCount) {
                const url = `${baseUrl}?` + new URLSearchParams({
                    where: '1=1',
                    outFields: '*',
                    returnGeometry: 'true',
                    f: 'geojson',
                    resultOffset: offset,
                    resultRecordCount: pageSize
                });

                try {
                    const resp = await fetch(url);
                    const data = await resp.json();
                    const n = (data.features && data.features.length) || 0;

                    if (n > 0) {
                        features = features.concat(data.features);
                        offset += n;

                        const progress = progressStart + (offset / totalCount) * (progressEnd - progressStart);
                        document.getElementById('progress-bar').style.width =
                            `${Math.min(progress, progressEnd)}%`;
                        document.getElementById('loading-status').textContent =
                            `${statusPrefix}: ${offset.toLocaleString()}...`;

                        if (offset >= totalCount) {
                            hasMore = false;
                        }
                    } else {
                        hasMore = false;
                    }
                } catch (e) {
                    console.error(`Page fetch failed for ${statusPrefix}`, e);
                    hasMore = false;
                }

                await new Promise(r => setTimeout(r, 30));
            }

            // If we got fewer than the reported total, mark as partial
            if (features.length < totalCount) {
                partialDataLoaded = true;
                console.warn(`WARNING: got ${features.length} of ${totalCount} for ${statusPrefix}`);
            }

            return { type: 'FeatureCollection', features };
        }

        function findFeaturesInBuffer(center, radius) {
            const buffer = turf.circle(center, radius, { steps: 64, units: 'miles' });
            const results = { lines: [], substations: [], pipelines: [] };

            if (allTransmissionLines) {
                for (const f of allTransmissionLines.features) {
                    try {
                        if (turf.booleanIntersects(f, buffer)) results.lines.push(f);
                    } catch (e) {}
                }
            }
            if (allSubstations) {
                for (const f of allSubstations.features) {
                    try {
                        if (turf.booleanPointInPolygon(f, buffer))
                            results.substations.push(f);
                    } catch (e) {}
                }
            }
            if (allPipelines) {
                for (const f of allPipelines.features) {
                    try {
                        if (turf.booleanIntersects(f, buffer)) results.pipelines.push(f);
                    } catch (e) {}
                }
            }
            return results;
        }

        function updateBuffer(lngLat) {
            const center = [lngLat.lng, lngLat.lat];
            const buffer = turf.circle(center, currentBufferRadius, {
                steps: 64,
                units: 'miles'
            });

            if (map.getSource('buffer')) {
                map.getSource('buffer').setData(buffer);
            } else {
                map.addSource('buffer', { type: 'geojson', data: buffer });
                map.addLayer(
                    {
                        id: 'buffer-fill',
                        type: 'fill',
                        source: 'buffer',
                        paint: {
                            'fill-color': '#38bdf8',
                            'fill-opacity': 0.14
                        }
                    },
                    'transmission-glow'
                );
                map.addLayer(
                    {
                        id: 'buffer-outline',
                        type: 'line',
                        source: 'buffer',
                        paint: {
                            'line-color': '#38bdf8',
                            'line-width': 2,
                            'line-dasharray': [3, 2]
                        }
                    },
                    'transmission-glow'
                );
            }

            if (!currentMarker) {
                const el = document.createElement('div');
                el.className = 'buffer-marker';
                currentMarker = new maplibregl.Marker(el).setLngLat(lngLat).addTo(map);
            } else {
                currentMarker.setLngLat(lngLat);
            }

            displayResults(findFeaturesInBuffer(center, currentBufferRadius), center);
        }

        function displayResults(results, coords) {
            currentBufferResults = results;
            document.getElementById('buffer-coords').textContent =
                `${coords[1].toFixed(4)}Â°, ${coords[0].toFixed(4)}Â°`;
            document.getElementById('buffer-radius-display').textContent =
                `${currentBufferRadius}-mile radius`;
            document.getElementById('line-count').textContent =
                results.lines.length;
            document.getElementById('substation-count').textContent =
                results.substations.length;
            document.getElementById('pipeline-count').textContent =
                results.pipelines.length;

            // Highest numeric voltage in buffer â†’ "### kV"
            let maxVoltage = null;
            if (results.lines.length > 0) {
                results.lines.forEach(f => {
                    const p = f.properties || {};
                    const raw = p.VOLTAGE || p.VOLT_CLASS || '';
                    const nums = String(raw).match(/\d+/g);
                    if (!nums) return;
                    const highestInFeature = Math.max(
                        ...nums.map(n => Number(n))
                    );
                    if (maxVoltage === null || highestInFeature > maxVoltage) {
                        maxVoltage = highestInFeature;
                    }
                });
            }
            document.getElementById('highest-voltage').textContent =
                maxVoltage !== null ? `${maxVoltage} kV` : 'â€”';

            const linesEl = document.getElementById('results-lines');
            const subsEl = document.getElementById('results-substations');
            const pipesEl = document.getElementById('results-pipelines');

            linesEl.innerHTML = '';
            subsEl.innerHTML = '';
            pipesEl.innerHTML = '';

            if (results.lines.length === 0) {
                linesEl.innerHTML =
                    '<div class="no-results"><div class="icon">âš¡</div><p>No transmission lines found.</p></div>';
            } else {
                results.lines
                    .sort(
                        (a, b) =>
                            getVoltageRank(b.properties.VOLT_CLASS) -
                            getVoltageRank(a.properties.VOLT_CLASS)
                    )
                    .forEach(f => {
                        const p = f.properties;
                        const vr = getVoltageRank(p.VOLT_CLASS);
                        linesEl.innerHTML += `
                            <div class="item-card">
                                <div class="item-title v${vr}">
                                    ${getVoltageCategory(p.VOLT_CLASS)}
                                </div>
                                <div class="item-detail">
                                    <span class="item-label">Type</span>
                                    <span class="item-value">${p.TYPE || 'N/A'}</span>
                                </div>
                                <div class="item-detail">
                                    <span class="item-label">Status</span>
                                    <span class="item-value">${p.STATUS || 'N/A'}</span>
                                </div>
                                <div class="item-detail">
                                    <span class="item-label">Owner</span>
                                    <span class="item-value">${p.OWNER || 'N/A'}</span>
                                </div>
                                <div class="item-detail">
                                    <span class="item-label">Operator</span>
                                    <span class="item-value">${p.OPERATOR || 'N/A'}</span>
                                </div>
                                <div class="item-detail">
                                    <span class="item-label">Voltage</span>
                                    <span class="item-value">${p.VOLTAGE || p.VOLT_CLASS || 'N/A'}</span>
                                </div>
                                <div class="item-detail">
                                    <span class="item-label">Sub 1</span>
                                    <span class="item-value">${p.SUB_1 || 'N/A'}</span>
                                </div>
                                <div class="item-detail">
                                    <span class="item-label">Sub 2</span>
                                    <span class="item-value">${p.SUB_2 || 'N/A'}</span>
                                </div>
                            </div>`;
                    });
            }

            if (results.substations.length === 0) {
                subsEl.innerHTML =
                    '<div class="no-results"><div class="icon">ðŸ”Œ</div><p>No substations found.</p></div>';
            } else {
                results.substations.forEach(f => {
                    const p = f.properties;
                    subsEl.innerHTML += `
                        <div class="item-card substation">
                            <div class="item-title substation">
                                ${p.NAME || 'Substation'}
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Type</span>
                                <span class="item-value">${p.TYPE || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Status</span>
                                <span class="item-value">${p.STATUS || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Owner</span>
                                <span class="item-value">${p.OWNER || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Voltage</span>
                                <span class="item-value">${p.MAX_VOLT || p.VOLTAGE || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">City</span>
                                <span class="item-value">${p.CITY || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">State</span>
                                <span class="item-value">${p.STATE || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">County</span>
                                <span class="item-value">${p.COUNTY || 'N/A'}</span>
                            </div>
                        </div>`;
                });
            }

            if (results.pipelines.length === 0) {
                pipesEl.innerHTML =
                    '<div class="no-results"><div class="icon">ðŸ”¥</div><p>No gas pipelines found.</p></div>';
            } else {
                results.pipelines.forEach(f => {
                    const p = f.properties;
                    pipesEl.innerHTML += `
                        <div class="item-card pipeline">
                            <div class="item-title pipeline">
                                ${p.Pipename || p.PIPENAME || 'Gas Pipeline'}
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Operator</span>
                                <span class="item-value">${p.Operator || p.OPERATOR || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Owner</span>
                                <span class="item-value">${p.Owner || p.OWNER || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Type</span>
                                <span class="item-value">${p.Typepipe || p.TYPE || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Status</span>
                                <span class="item-value">${p.Status || p.STATUS || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Diameter</span>
                                <span class="item-value">${p.Diameter || 'N/A'}</span>
                            </div>
                            <div class="item-detail">
                                <span class="item-label">Interstate</span>
                                <span class="item-value">${p.Interstate || 'N/A'}</span>
                            </div>
                        </div>`;
                });
            }

            document.getElementById('buffer-panel').classList.add('visible');
        }

        function clearBuffer() {
            ['buffer-fill', 'buffer-outline'].forEach(l => {
                if (map.getLayer(l)) map.removeLayer(l);
            });
            if (map.getSource('buffer')) map.removeSource('buffer');
            if (currentMarker) {
                currentMarker.remove();
                currentMarker = null;
            }
            lastClickedLngLat = null;
            currentBufferResults = null;
            document.getElementById('buffer-panel').classList.remove('visible');
        }

        document.getElementById('close-buffer').addEventListener('click', clearBuffer);

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2600);
        }

        // Download helper
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Convert features to CSV (works with any properties, including _layer)
        function featuresToCSV(features) {
            if (!features || features.length === 0) return '';

            const allKeys = new Set();
            features.forEach(f => {
                if (f.properties) {
                    Object.keys(f.properties).forEach(k => allKeys.add(k));
                }
            });

            const keys = ['latitude', 'longitude', ...Array.from(allKeys)];

            let csv = keys.map(k => `"${k}"`).join(',') + '\n';

            features.forEach(f => {
                let lat = '',
                    lng = '';
                if (f.geometry) {
                    if (f.geometry.type === 'Point') {
                        lng = f.geometry.coordinates[0];
                        lat = f.geometry.coordinates[1];
                    } else if (
                        f.geometry.type === 'LineString' &&
                        f.geometry.coordinates.length > 0
                    ) {
                        const mid = Math.floor(f.geometry.coordinates.length / 2);
                        lng = f.geometry.coordinates[mid][0];
                        lat = f.geometry.coordinates[mid][1];
                    } else if (
                        f.geometry.type === 'MultiLineString' &&
                        f.geometry.coordinates.length > 0
                    ) {
                        const firstLine = f.geometry.coordinates[0];
                        if (firstLine.length > 0) {
                            const mid = Math.floor(firstLine.length / 2);
                            lng = firstLine[mid][0];
                            lat = firstLine[mid][1];
                        }
                    }
                }

                const row = keys.map(k => {
                    if (k === 'latitude') return lat;
                    if (k === 'longitude') return lng;
                    const val = f.properties ? f.properties[k] : '';
                    if (val === null || val === undefined) return '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csv += row.join(',') + '\n';
            });

            return csv;
        }

        // Export current layer (active tab) in buffer â€“ single file, tagged with _layer
        document.getElementById('export-current-csv').addEventListener('click', () => {
            if (!currentBufferResults) {
                showToast('No buffer results to export');
                return;
            }

            const activeTab = document.querySelector('.buffer-tab.active');
            const tabKey = activeTab ? activeTab.dataset.tab : 'lines';
            const key =
                tabKey === 'lines'
                    ? 'lines'
                    : tabKey === 'substations'
                    ? 'substations'
                    : 'pipelines';

            const layerTag =
                key === 'lines'
                    ? 'transmission'
                    : key === 'substations'
                    ? 'substation'
                    : 'pipeline';

            const features = (currentBufferResults[key] || []).map(f => ({
                ...f,
                properties: {
                    ...f.properties,
                    _layer: layerTag
                }
            }));

            if (!features.length) {
                showToast('No features in current layer to export');
                return;
            }

            const timestamp = new Date().toISOString().slice(0, 10);
            const coords = lastClickedLngLat
                ? `${lastClickedLngLat.lat.toFixed(4)}_${lastClickedLngLat.lng.toFixed(
                      4
                  )}`
                : 'unknown';

            const csv = featuresToCSV(features);
            downloadFile(
                csv,
                `buffer_${key}_${coords}_${currentBufferRadius}mi_${timestamp}.csv`,
                'text/csv'
            );
            showToast(
                `Exported ${features.length.toLocaleString()} ${tabKey} features to CSV`
            );
        });

        document
            .getElementById('export-current-geojson')
            .addEventListener('click', () => {
                if (!currentBufferResults) {
                    showToast('No buffer results to export');
                    return;
                }

                const activeTab = document.querySelector('.buffer-tab.active');
                const tabKey = activeTab ? activeTab.dataset.tab : 'lines';
                const key =
                    tabKey === 'lines'
                        ? 'lines'
                        : tabKey === 'substations'
                        ? 'substations'
                        : 'pipelines';

                const layerTag =
                    key === 'lines'
                        ? 'transmission'
                        : key === 'substations'
                        ? 'substation'
                        : 'pipeline';

                const features = (currentBufferResults[key] || []).map(f => ({
                    ...f,
                    properties: {
                        ...f.properties,
                        _layer: layerTag
                    }
                }));

                if (!features.length) {
                    showToast('No features in current layer to export');
                    return;
                }

                const timestamp = new Date().toISOString().slice(0, 10);
                const coords = lastClickedLngLat
                    ? `${lastClickedLngLat.lat.toFixed(4)}_${lastClickedLngLat.lng.toFixed(
                          4
                      )}`
                    : 'unknown';

                const collection = {
                    type: 'FeatureCollection',
                    features,
                    metadata: {
                        exported: new Date().toISOString(),
                        source: 'LandVolt Snapshot â€” Buffer (Current Layer)',
                        buffer_center: lastClickedLngLat
                            ? [lastClickedLngLat.lng, lastClickedLngLat.lat]
                            : null,
                        buffer_radius_miles: currentBufferRadius,
                        layer: layerTag,
                        feature_count: features.length
                    }
                };

                downloadFile(
                    JSON.stringify(collection, null, 2),
                    `buffer_${key}_${coords}_${currentBufferRadius}mi_${timestamp}.geojson`,
                    'application/geo+json'
                );
                showToast(
                    `Exported ${features.length.toLocaleString()} ${tabKey} features to GeoJSON`
                );
            });

        // Export ALL buffer layers together â€“ single CSV / GeoJSON with _layer property
        document.getElementById('export-buffer-csv').addEventListener('click', () => {
            if (!currentBufferResults) {
                showToast('No buffer results to export');
                return;
            }

            const combined = [
                ...currentBufferResults.lines.map(f => ({
                    ...f,
                    properties: {
                        ...f.properties,
                        _layer: 'transmission'
                    }
                })),
                ...currentBufferResults.substations.map(f => ({
                    ...f,
                    properties: {
                        ...f.properties,
                        _layer: 'substation'
                    }
                })),
                ...currentBufferResults.pipelines.map(f => ({
                    ...f,
                    properties: {
                        ...f.properties,
                        _layer: 'pipeline'
                    }
                }))
            ];

            if (!combined.length) {
                showToast('No features in buffer to export');
                return;
            }

            const timestamp = new Date().toISOString().slice(0, 10);
            const coords = lastClickedLngLat
                ? `${lastClickedLngLat.lat.toFixed(4)}_${lastClickedLngLat.lng.toFixed(
                      4
                  )}`
                : 'unknown';

            const csv = featuresToCSV(combined);
            downloadFile(
                csv,
                `buffer_all_layers_${coords}_${currentBufferRadius}mi_${timestamp}.csv`,
                'text/csv'
            );
            showToast(
                `Exported ${combined.length.toLocaleString()} features (all layers) to CSV`
            );
        });

        document
            .getElementById('export-buffer-geojson')
            .addEventListener('click', () => {
                if (!currentBufferResults) {
                    showToast('No buffer results to export');
                    return;
                }

                const combined = [
                    ...currentBufferResults.lines.map(f => ({
                        ...f,
                        properties: {
                            ...f.properties,
                            _layer: 'transmission'
                        }
                    })),
                    ...currentBufferResults.substations.map(f => ({
                        ...f,
                        properties: {
                            ...f.properties,
                            _layer: 'substation'
                        }
                    })),
                    ...currentBufferResults.pipelines.map(f => ({
                        ...f,
                        properties: {
                            ...f.properties,
                            _layer: 'pipeline'
                        }
                    }))
                ];

                const totalFeatures = combined.length;
                if (!totalFeatures) {
                    showToast('No features in buffer to export');
                    return;
                }

                const timestamp = new Date().toISOString().slice(0, 10);
                const coords = lastClickedLngLat
                    ? `${lastClickedLngLat.lat.toFixed(4)}_${lastClickedLngLat.lng.toFixed(
                          4
                      )}`
                    : 'unknown';

                const bufferPolygon = lastClickedLngLat
                    ? turf.circle(
                          [lastClickedLngLat.lng, lastClickedLngLat.lat],
                          currentBufferRadius,
                          { steps: 64, units: 'miles' }
                      )
                    : null;

                const collection = {
                    type: 'FeatureCollection',
                    features: [
                        ...(bufferPolygon
                            ? [
                                  {
                                      ...bufferPolygon,
                                      properties: {
                                          _type: 'buffer_boundary',
                                          radius_miles: currentBufferRadius,
                                          center_lat: lastClickedLngLat.lat,
                                          center_lng: lastClickedLngLat.lng
                                      }
                                  }
                              ]
                            : []),
                        ...combined
                    ],
                    metadata: {
                        exported: new Date().toISOString(),
                        source: 'LandVolt Snapshot â€” Buffer (All Layers)',
                        buffer_center: lastClickedLngLat
                            ? [lastClickedLngLat.lng, lastClickedLngLat.lat]
                            : null,
                        buffer_radius_miles: currentBufferRadius,
                        feature_counts: {
                            transmission_lines: currentBufferResults.lines.length,
                            substations: currentBufferResults.substations.length,
                            pipelines: currentBufferResults.pipelines.length
                        }
                    }
                };

                downloadFile(
                    JSON.stringify(collection, null, 2),
                    `buffer_all_layers_${coords}_${currentBufferRadius}mi_${timestamp}.geojson`,
                    'application/geo+json'
                );
                showToast(
                    `Exported ${totalFeatures.toLocaleString()} features + buffer boundary to GeoJSON`
                );
            });

        map.on('load', async () => {
            try {
                // Transmission lines
                allTransmissionLines = await fetchPaginated(
                    'https://services2.arcgis.com/FiaPA4ga0iQKduv3/arcgis/rest/services/US_Electric_Power_Transmission_Lines/FeatureServer/0/query',
                    'Loading transmission lines',
                    0,
                    40
                );
                allTransmissionLines.features.forEach(f => {
                    if (f.properties) {
                        f.properties.voltage_rank = getVoltageRank(
                            f.properties.VOLT_CLASS
                        );
                        f.properties.voltage_category = getVoltageCategory(
                            f.properties.VOLT_CLASS
                        );
                    }
                });
                document.getElementById('lineCount').textContent =
                    allTransmissionLines.features.length.toLocaleString();
                document.getElementById('transmission-count').textContent =
                    allTransmissionLines.features.length.toLocaleString();

                // Substations
                allSubstations = await fetchPaginated(
                    'https://services6.arcgis.com/OO2s4OoyCZkYJ6oE/arcgis/rest/services/Substations/FeatureServer/0/query',
                    'Loading substations',
                    40,
                    70
                );
                document.getElementById('substationCount').textContent =
                    allSubstations.features.length.toLocaleString();
                document.getElementById('substations-count').textContent =
                    allSubstations.features.length.toLocaleString();

                // Pipelines
                allPipelines = await fetchPaginated(
                    'https://services2.arcgis.com/FiaPA4ga0iQKduv3/arcgis/rest/services/Natural_Gas_Interstate_and_Intrastate_Pipelines_1/FeatureServer/0/query',
                    'Loading gas pipelines',
                    70,
                    100
                );
                document.getElementById('pipelineCount').textContent =
                    allPipelines.features.length.toLocaleString();
                document.getElementById('pipelines-count').textContent =
                    allPipelines.features.length.toLocaleString();

                document.getElementById('loading-status').textContent =
                    'Rendering map...';
                document.getElementById('progress-bar').style.width = '100%';
                if (partialDataLoaded) {
                    document.getElementById('loading-status').textContent =
                            'Warning: not all grid data could be loaded. Please reload the page to try again.';
                        alert('Warning: Not all grid data could be loaded from the server. ' +
                            'Some lines or stations may be missing. Please reload the page to try again.');
                    }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('stats').classList.add('visible');
                // Sources
                map.addSource('transmission-lines', {
                    type: 'geojson',
                    data: allTransmissionLines
                });
                map.addSource('substations', {
                    type: 'geojson',
                    data: allSubstations
                });
                map.addSource('pipelines', { type: 'geojson', data: allPipelines });

                // Transmission layers
                map.addLayer({
                    id: 'transmission-glow',
                    type: 'line',
                    source: 'transmission-lines',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': [
                            'match',
                            ['get', 'voltage_rank'],
                            1,
                            glowColors[1],
                            2,
                            glowColors[2],
                            3,
                            glowColors[3],
                            4,
                            glowColors[4],
                            5,
                            glowColors[5],
                            6,
                            glowColors[6],
                            7,
                            glowColors[7],
                            glowColors[1]
                        ],
                        'line-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            1.5,
                            6,
                            5,
                            10,
                            10
                        ],
                        'line-blur': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            0.5,
                            6,
                            2,
                            10,
                            4
                        ],
                        'line-opacity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            0.15,
                            5,
                            0.3,
                            7,
                            0.4
                        ]
                    }
                });
                map.addLayer({
                    id: 'transmission-core',
                    type: 'line',
                    source: 'transmission-lines',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': [
                            'match',
                            ['get', 'voltage_rank'],
                            1,
                            glowColors[1],
                            2,
                            glowColors[2],
                            3,
                            glowColors[3],
                            4,
                            glowColors[4],
                            5,
                            glowColors[5],
                            6,
                            glowColors[6],
                            7,
                            glowColors[7],
                            glowColors[1]
                        ],
                        'line-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            0.4,
                            6,
                            1.4,
                            10,
                            3.5
                        ],
                        'line-opacity': 0.9
                    }
                });

                // Pipelines (use distinct orange color, not overlapping voltage classes)
                map.addLayer({
                    id: 'pipelines-glow',
                    type: 'line',
                    source: 'pipelines',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': '#f97316',
                        'line-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            1.5,
                            6,
                            4,
                            10,
                            9
                        ],
                        'line-blur': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            0.5,
                            6,
                            1.5,
                            10,
                            3
                        ],
                        'line-opacity': 0.25
                    }
                });
                map.addLayer({
                    id: 'pipelines-core',
                    type: 'line',
                    source: 'pipelines',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': '#f97316',
                        'line-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            0.4,
                            6,
                            1.2,
                            10,
                            3
                        ],
                        'line-opacity': 0.9
                    }
                });

                // Substations (smaller when zoomed out)
                map.addLayer({
                    id: 'substations-glow',
                    type: 'circle',
                    source: 'substations',
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            1.5,   /* smaller at low zoom */
                            8,
                            6,
                            12,
                            12
                        ],
                        'circle-color': '#f97373',
                        'circle-blur': 0.8,
                        'circle-opacity': 0.35
                    }
                });
                map.addLayer({
                    id: 'substations-core',
                    type: 'circle',
                    source: 'substations',
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            1,
                            8,
                            3.5,
                            12,
                            6
                        ],
                        'circle-color': '#f97373',
                        'circle-stroke-color': '#e5e7eb',
                        'circle-stroke-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            3,
                            0,
                            8,
                            0.8,
                            12,
                            1.4
                        ],
                        'circle-opacity': 0.95
                    }
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('stats').classList.add('visible');

                // Map click handler
                map.on('click', e => {
                    const lineF = map.queryRenderedFeatures(e.point, {
                        layers: ['transmission-core']
                    });
                    const subF = map.queryRenderedFeatures(e.point, {
                        layers: ['substations-core']
                    });
                    const pipeF = map.queryRenderedFeatures(e.point, {
                        layers: ['pipelines-core']
                    });

                    if (lineF.length > 0) {
                        const p = lineF[0].properties;
                        new maplibregl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(
                                `<div class="popup-content">
                                    <div class="popup-title">${p.voltage_category ||
                                        getVoltageCategory(p.VOLT_CLASS)}</div>
                                    <div class="popup-row">
                                        <span class="popup-label">Type</span>
                                        <span class="popup-value">${p.TYPE ||
                                            'N/A'}</span>
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">Owner</span>
                                        <span class="popup-value">${p.OWNER ||
                                            'N/A'}</span>
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">Status</span>
                                        <span class="popup-value">${p.STATUS ||
                                            'N/A'}</span>
                                    </div>
                                </div>`
                            )
                            .addTo(map);
                    } else if (pipeF.length > 0) {
                        const p = pipeF[0].properties;
                        new maplibregl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(
                                `<div class="popup-content">
                                    <div class="popup-title">
                                        ${p.Pipename || p.PIPENAME || 'Gas Pipeline'}
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">Operator</span>
                                        <span class="popup-value">${p.Operator ||
                                            p.OPERATOR ||
                                            'N/A'}</span>
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">Type</span>
                                        <span class="popup-value">${p.Typepipe ||
                                            p.TYPE ||
                                            'N/A'}</span>
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">Diameter</span>
                                        <span class="popup-value">${p.Diameter ||
                                            'N/A'}</span>
                                    </div>
                                </div>`
                            )
                            .addTo(map);
                    } else if (subF.length > 0) {
                        const p = subF[0].properties;
                        new maplibregl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(
                                `<div class="popup-content">
                                    <div class="popup-title">
                                        ${p.NAME || 'Substation'}
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">Owner</span>
                                        <span class="popup-value">${p.OWNER ||
                                            'N/A'}</span>
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">City</span>
                                        <span class="popup-value">${p.CITY ||
                                            'N/A'}</span>
                                    </div>
                                    <div class="popup-row">
                                        <span class="popup-label">State</span>
                                        <span class="popup-value">${p.STATE ||
                                            'N/A'}</span>
                                    </div>
                                </div>`
                            )
                            .addTo(map);
                    } else {
                        lastClickedLngLat = e.lngLat;
                        updateBuffer(e.lngLat);
                    }
                });

                // Hover cursor
                ['transmission-core', 'substations-core', 'pipelines-core'].forEach(
                    l => {
                        map.on('mouseenter', l, () => {
                            map.getCanvas().style.cursor = 'pointer';
                        });
                        map.on('mouseleave', l, () => {
                            map.getCanvas().style.cursor = 'crosshair';
                        });
                    }
                );
                map.getCanvas().style.cursor = 'crosshair';

                // Basemap toggle (after layers exist)
                document
                    .querySelectorAll('input[name="basemap"]')
                    .forEach(radio => {
                        radio.addEventListener('change', () => {
                            const val = radio.value;
                            if (!map.getLayer('carto-dark-layer')) return;
                            if (!map.getLayer('esri-imagery-layer')) return;

                            if (val === 'dark') {
                                map.setLayoutProperty(
                                    'carto-dark-layer',
                                    'visibility',
                                    'visible'
                                );
                                map.setLayoutProperty(
                                    'esri-imagery-layer',
                                    'visibility',
                                    'none'
                                );
                            } else {
                                map.setLayoutProperty(
                                    'carto-dark-layer',
                                    'visibility',
                                    'none'
                                );
                                map.setLayoutProperty(
                                    'esri-imagery-layer',
                                    'visibility',
                                    'visible'
                                );
                            }
                        });
                    });
            } catch (err) {
                console.error('Error:', err);
                document.querySelector('.loading-text').textContent =
                    'Error loading data';
                document.querySelector('.loading-subtext').textContent =
                    'Refresh to try again';
            }
        });
    </script>
</body>
</html>

